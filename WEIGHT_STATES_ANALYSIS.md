# Анализ всех возможных состояний грузов

## Структуры данных

```javascript
state = {
  usedWeightIds: Set(),        // Грузы на canvas (свободные)
  selectedWeights: Set(),       // Грузы подвешенные к оборудованию
  attachedWeights: [],          // Массив грузов в цепочке на пружине/динамометре
  freeWeights: []              // Грузы на canvas с координатами и стопками
}
```

## 6 возможных состояний груза

### 1. **В КОМПЛЕКТЕ** (available)
- `usedWeightIds`: ❌ НЕТ
- `selectedWeights`: ❌ НЕТ
- `attachedWeights`: ❌ НЕТ
- `freeWeights`: ❌ НЕТ

**UI:** Подсказка "Перетащите на установку"
**Кнопка:** НЕТ

---

### 2. **СВОБОДНЫЙ НА CANVAS** (одиночный)
- `usedWeightIds`: ✅ ЕСТЬ
- `selectedWeights`: ❌ НЕТ
- `attachedWeights`: ❌ НЕТ
- `freeWeights`: ✅ ЕСТЬ (как основной элемент)

**UI:** Статус "На столе"
**Кнопка:** "Убрать" → возврат в комплект

---

### 3. **СВОБОДНЫЙ НА CANVAS** (нижний в стопке)
- `usedWeightIds`: ✅ ЕСТЬ
- `selectedWeights`: ❌ НЕТ
- `attachedWeights`: ❌ НЕТ
- `freeWeights`: ✅ ЕСТЬ (как основной элемент)
- `freeWeights[x].stackedWeights`: ✅ ЕСТЬ (массив с верхними грузами)

**UI:** Статус "На столе (сцеплен с N грузами)"
**Кнопка:** "Убрать" → возврат ВСЕЙ стопки в комплект

---

### 4. **СВОБОДНЫЙ НА CANVAS** (верхний в стопке)
- `usedWeightIds`: ✅ ЕСТЬ
- `selectedWeights`: ❌ НЕТ
- `attachedWeights`: ❌ НЕТ
- `freeWeights`: ❌ НЕТ (как основной)
- `freeWeights[x].stackedWeights`: ✅ ЕСТЬ (внутри массива другого груза)

**UI:** Статус "На столе (в стопке)"
**Кнопка:** "Убрать" → возврат ТОЛЬКО этого груза

---

### 5. **ПОДВЕШЕН НА ПРУЖИНЕ** (НЕ последний)
- `usedWeightIds`: ❌ НЕТ (удаляется при подвешивании)
- `selectedWeights`: ✅ ЕСТЬ
- `attachedWeights`: ✅ ЕСТЬ (позиция < lastIndex)

**UI:** Статус "На пружине (1-й в цепочке)" / "2-й в цепочке"
**Кнопка:** НЕТ (нельзя снять средний груз)

---

### 6. **ПОДВЕШЕН НА ПРУЖИНЕ** (последний)
- `usedWeightIds`: ❌ НЕТ
- `selectedWeights`: ✅ ЕСТЬ
- `attachedWeights`: ✅ ЕСТЬ (позиция === lastIndex)

**UI:** Статус "На пружине (N-й в цепочке)"
**Кнопка:** "Снять" → возврат в комплект

---

## Логика определения состояния

```javascript
const isInUsed = this.state.usedWeightIds.has(weight.id);
const isInSelected = this.state.selectedWeights.has(weight.id);

const isFreeOnCanvas = isInUsed && !isInSelected;  // Состояния 2, 3, 4
const isAttached = isInSelected;                    // Состояния 5, 6

const attachedArray = this.state.attachedWeights || [];
const lastIndex = attachedArray.length > 0 ? attachedArray.length - 1 : -1;
const lastWeightInChain = attachedArray[lastIndex];
const isLastInChain = isAttached && lastWeightInChain?.id === weight.id;  // Состояние 6
```

## Правила показа кнопок

```javascript
if (isAttached && isLastInChain) {
    // Состояние 6: Последний на пружине
    showButton("Снять");
    
} else if (isFreeOnCanvas) {
    // Состояния 2, 3, 4: Свободный на canvas
    showButton("Убрать");
    
} else if (!isAttached && !isPending && !isFreeOnCanvas) {
    // Состояние 1: В комплекте
    showHint("Перетащите");
    
} else {
    // Состояние 5: Средний на пружине или pending
    hideButton();
}
```

## Переходы между состояниями

```
1. В комплекте
   │
   ├─→ Drag на canvas → 2. Свободный (одиночный)
   │                     │
   │                     ├─→ Drag другого груза рядом → 3. Нижний в стопке
   │                     │                              4. Верхний в стопке
   │                     │
   │                     └─→ Drag на пружину → 6. Последний подвешен
   │
   └─→ Drag на пружину → 6. Последний подвешен
                         │
                         └─→ Drag ещё груз → 5. Средний + 6. Последний
```

## Тестовые сценарии

### Тест 1: Одиночный груз на пружине
1. Перетащить груз №1 на пружину
2. ✅ Груз №1: Состояние 6 (последний), кнопка "Снять"

### Тест 2: Два груза на пружине
1. Перетащить груз №1 на пружину
2. Перетащить груз №2 на пружину
3. ✅ Груз №1: Состояние 5 (средний), БЕЗ кнопки
4. ✅ Груз №2: Состояние 6 (последний), кнопка "Снять"

### Тест 3: Три груза на пружине
1. Перетащить грузы №1, №2, №3 на пружину
2. ✅ Груз №1: Состояние 5, БЕЗ кнопки
3. ✅ Груз №2: Состояние 5, БЕЗ кнопки
4. ✅ Груз №3: Состояние 6, кнопка "Снять"

### Тест 4: Снятие грузов с пружины
1. Три груза на пружине
2. Нажать "Снять" у груза №3
3. ✅ Груз №3 удаляется
4. ✅ Груз №2 становится последним (Состояние 6), появляется кнопка "Снять"
5. ✅ Груз №1 остаётся средним (Состояние 5), БЕЗ кнопки

### Тест 5: Груз на canvas
1. Перетащить груз №1 на canvas (мимо пружины)
2. ✅ Груз №1: Состояние 2 (одиночный), кнопка "Убрать"

### Тест 6: Стопка на canvas
1. Перетащить груз №1 на canvas
2. Перетащить груз №2 рядом с №1 (сцепляются)
3. ✅ Груз №1: Состояние 3 (нижний), кнопка "Убрать"
4. ✅ Груз №2: Состояние 4 (верхний), кнопка "Убрать"
5. Нажать "Убрать" у груза №1 → оба возвращаются
6. Нажать "Убрать" у груза №2 → только №2 возвращается

## Частые проблемы

### Проблема: Нет кнопки у последнего груза на пружине
**Причина:** `isLastInChain` определяется неправильно
**Решение:** Проверить `attachedWeights[lastIndex].id === weight.id`

### Проблема: Кнопка "Убрать" не работает для верхнего груза в стопке
**Причина:** `removeFreeWeight` не ищет в `stackedWeights`
**Решение:** Добавить поиск в `freeWeights[x].stackedWeights`

### Проблема: Груз на пружине показывает "На столе"
**Причина:** Груз остался в `usedWeightIds` после подвешивания
**Решение:** В `addWeightToChain` удалять из `usedWeightIds`
