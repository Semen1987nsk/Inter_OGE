# 🎨 ВИЗУАЛЬНАЯ СХЕМА СОСТОЯНИЙ ГРУЗОВ

```
┌─────────────────────────────────────────────────────────────────────┐
│                     ИНВЕНТАРЬ ГРУЗОВ (Правая панель)                │
└─────────────────────────────────────────────────────────────────────┘

                           getWeightState(weightId)
                                      │
                                      ▼
        ┌─────────────────────────────────────────────────────┐
        │  🔍 АНАЛИЗ СОСТОЯНИЯ (8 проверок)                   │
        ├─────────────────────────────────────────────────────┤
        │  1️⃣ selectedWeights.has(id) ?                       │
        │  2️⃣ attachedWeights.findIndex(id) ?                 │
        │  3️⃣ Диск в compositeDisks подвешенной штанги?       │
        │  4️⃣ freeWeights.find(id) ?                          │
        │  5️⃣ Диск в compositeDisks свободной штанги?         │
        │  6️⃣ Груз в stackedWeights ?                         │
        │  7️⃣ pendingWeightIds.has(id) ?                      │
        │  8️⃣ Определение финального state                    │
        └─────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                        КЛАССИФИКАЦИЯ СОСТОЯНИЙ                           │
└──────────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐
│   🟢 available      │  Груз в комплекте
│   (В комплекте)     │  ──────────────────────────────
├─────────────────────┤  Кнопка: [Перетащите на установку]
│ canRemove: false    │  Действие: Можно drag & drop
│ buttonText: null    │
└─────────────────────┘

┌─────────────────────┐
│   ⏳ pending         │  Груз в процессе подвешивания
│   (Анимация)        │  ──────────────────────────────
├─────────────────────┤  Кнопка: НЕТ
│ canRemove: false    │  Статус: "Подвешивается…"
│ buttonText: null    │  Действие: Ждём завершения анимации
└─────────────────────┘

┌─────────────────────┐
│ 🔴 attached-last    │  Последний груз в цепочке
│ (На оборудовании)   │  ──────────────────────────────
├─────────────────────┤  Кнопка: [Снять] ✅
│ canRemove: true     │  Действие: detachWeight(id)
│ removeAction:       │  Статус: "На пружине (3-й)"
│  'detach'           │  Пружина: Укорачивается
│ buttonText: 'Снять' │  Композит: Снимает штангу + ВСЕ диски
└─────────────────────┘

┌─────────────────────┐
│ ⚪ attached-middle   │  Груз в середине цепочки
│ (На оборудовании)   │  ──────────────────────────────
├─────────────────────┤  Кнопка: НЕТ
│ canRemove: false    │  Статус: "На пружине (1-й)"
│ buttonText: null    │  Действие: Сначала снять нижние
└─────────────────────┘

┌──────────────────────────┐
│ 🔩 attached-composite-   │  Диск на подвешенной штанге
│     disk                 │  ──────────────────────────────
├──────────────────────────┤  Кнопка: НЕТ
│ canRemove: false         │  Статус: "На штанге (пружине)"
│ buttonText: null         │  Действие: Снять штангу целиком
│ parentRodId: 'rod_10g'   │  Запрет: Нельзя снять отдельно!
└──────────────────────────┘

┌─────────────────────┐
│ 🟡 free-on-canvas   │  Груз свободно на столе
│ (На столе)          │  ──────────────────────────────
├─────────────────────┤  Кнопка: [Убрать] ✅
│ canRemove: true     │  Действие: removeFreeWeight(id)
│ removeAction:       │  Статус: "На столе"
│  'remove-free'      │  Композит: "На столе (2 диска, 70г)"
│ buttonText: 'Убрать'│  Стопка: "На столе (сцеплен с 2)"
└─────────────────────┘

┌─────────────────────────┐
│ 🔧 free-composite-disk  │  Диск на свободной штанге
│ (На столе)              │  ──────────────────────────────
├─────────────────────────┤  Кнопка: [Убрать диск] ✅
│ canRemove: true         │  Действие: removeFreeWeight(id)
│ removeAction:           │  Статус: "На штанге (стол)"
│  'remove-disk'          │  Эффект: Убирает ТОЛЬКО диск
│ buttonText:             │  Штанга: Масса уменьшается
│  'Убрать диск'          │
│ freeRodId: 'rod_10g'    │
└─────────────────────────┘

┌─────────────────────────┐
│ 📚 free-in-stack        │  Груз в стопке на столе
│ (На столе)              │  ──────────────────────────────
├─────────────────────────┤  Кнопка: [Убрать] ✅
│ canRemove: true         │  Действие: removeFreeWeight(id)
│ removeAction:           │  Статус: "На столе (в стопке)"
│  'remove-from-stack'    │  Эффект: Убирает из стопки
│ buttonText: 'Убрать'    │  Нижний: Убирает ВСЮ стопку
│ stackBottomWeightId:    │
│  'weight100_1'          │
└─────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────┐
│                          ДИАГРАММА ПЕРЕХОДОВ                             │
└──────────────────────────────────────────────────────────────────────────┘

          [В комплекте]
         (available) 🟢
                │
                │ Drag & Drop
                ▼
        ┌───────────────┐
        │  Куда упал?   │
        └───────────────┘
                │
        ┌───────┴───────┬─────────────┐
        │               │             │
        ▼               ▼             ▼
  [На оборудование]  [На стол]   [На другой груз]
        │               │             │
        ▼               ▼             ▼
   (pending) ⏳    (free-on-     (соединение)
        │           canvas) 🟡        │
        │               │             │
   [Анимация]      [Можно          [Стопка/
        │           убрать]         Композит]
        ▼                               │
  (attached-last) 🔴                    ▼
        │                       (free-composite-disk) 🔧
        │                            или
   [Можно снять]              (free-in-stack) 📚
        │
        │ +Ещё груз
        ▼
  (attached-middle) ⚪
        │
   [Нельзя снять]


┌──────────────────────────────────────────────────────────────────────────┐
│                      ДЕЙСТВИЯ С КНОПКАМИ                                 │
└──────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐     detachWeight(id)      ┌──────────────────┐
│   attached-     │ ────────────────────────▶ │   available      │
│     last        │                            │                  │
│   [Снять] ✅    │  1. Удалить из attached    │ [Перетащите] 💡  │
└─────────────────┘  2. Удалить из selected    └──────────────────┘
                     3. Если композит:
                        - Вернуть ВСЕ диски
                     4. Пересчитать пружину
                     5. Обновить UI

┌─────────────────┐  removeFreeWeight(id)    ┌──────────────────┐
│  free-on-       │ ────────────────────────▶ │   available      │
│   canvas        │                            │                  │
│  [Убрать] ✅    │  1. Удалить из freeWeights │ [Перетащите] 💡  │
└─────────────────┘  2. Удалить из usedWeights └──────────────────┘
                     3. Если композит/стопка:
                        - Вернуть все части
                     4. Обновить UI

┌─────────────────┐  removeFreeWeight(id)    ┌──────────────────┐
│  free-          │ ────────────────────────▶ │   available      │
│  composite-     │                            │                  │
│   disk          │  1. Найти в compositeDisks │ [Перетащите] 💡  │
│ [Убрать диск]✅ │  2. Удалить ТОЛЬКО диск    └──────────────────┘
└─────────────────┘  3. Уменьшить массу штанги
                     4. Обновить UI штанги

┌─────────────────┐  removeFreeWeight(id)    ┌──────────────────┐
│  free-in-       │ ────────────────────────▶ │   available      │
│   stack         │                            │                  │
│  [Убрать] ✅    │  1. Найти в stackedWeights │ [Перетащите] 💡  │
└─────────────────┘  2. Удалить из стопки      └──────────────────┘
                     3. Если нижний в стопке:
                        - Вернуть ВСЮ стопку
                     4. Обновить UI


┌──────────────────────────────────────────────────────────────────────────┐
│                     ПРИМЕРЫ СТАТУСОВ                                     │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────┬─────────────────────────────────┐
│  СОСТОЯНИЕ                       │  СТАТУС В UI                    │
├──────────────────────────────────┼─────────────────────────────────┤
│  available                       │  "В комплекте"                  │
│  pending                         │  "Подвешивается…"               │
│  attached-last                   │  "На пружине (3-й в цепочке)"   │
│  attached-middle                 │  "На динамометре (1-й)"         │
│  attached-composite-disk         │  "На штанге (пружине)"          │
│  free-on-canvas (обычный)        │  "На столе"                     │
│  free-on-canvas (штанга)         │  "На столе (2 диска, 70г)"      │
│  free-on-canvas (стопка)         │  "На столе (сцеплен с 2)"       │
│  free-composite-disk             │  "На штанге (стол)"             │
│  free-in-stack                   │  "На столе (в стопке)"          │
└──────────────────────────────────┴─────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────┐
│                  ЛОГИКА ПРОВЕРОК (порядок важен!)                        │
└──────────────────────────────────────────────────────────────────────────┘

    function getWeightState(weightId) {
        
        ┌─────────────────────────────────────────────┐
        │  1️⃣ Проверка: selectedWeights.has(id)      │
        │     ▶ true = Груз подвешен напрямую         │
        └─────────────────────────────────────────────┘
                            │
                            ▼
        ┌─────────────────────────────────────────────┐
        │  2️⃣ Проверка: attachedWeights.find(id)     │
        │     ▶ Позиция в цепочке                     │
        │     ▶ Последний в цепочке?                  │
        └─────────────────────────────────────────────┘
                            │
                            ▼
        ┌─────────────────────────────────────────────┐
        │  3️⃣ Проверка: Диск на подвешенной штанге?  │
        │     ▶ Ищем в compositeDisks                 │
        │     ▶ Сохраняем parentRodId                 │
        └─────────────────────────────────────────────┘
                            │
                            ▼
        ┌─────────────────────────────────────────────┐
        │  4️⃣ Проверка: freeWeights.find(id)         │
        │     ▶ Груз свободен на canvas?              │
        └─────────────────────────────────────────────┘
                            │
                            ▼
        ┌─────────────────────────────────────────────┐
        │  5️⃣ Проверка: Диск на свободной штанге?    │
        │     ▶ Ищем в compositeDisks                 │
        │     ▶ Сохраняем freeRodId                   │
        └─────────────────────────────────────────────┘
                            │
                            ▼
        ┌─────────────────────────────────────────────┐
        │  6️⃣ Проверка: Груз в стопке?               │
        │     ▶ Ищем в stackedWeights                 │
        │     ▶ Сохраняем stackBottomWeightId         │
        └─────────────────────────────────────────────┘
                            │
                            ▼
        ┌─────────────────────────────────────────────┐
        │  7️⃣ Проверка: pendingWeightIds.has(id)     │
        │     ▶ В процессе анимации?                  │
        └─────────────────────────────────────────────┘
                            │
                            ▼
        ┌─────────────────────────────────────────────┐
        │  8️⃣ ОПРЕДЕЛЕНИЕ ФИНАЛЬНОГО STATE            │
        │     ▶ Приоритет:                            │
        │       pending > attached-composite-disk >   │
        │       attached-last > attached-middle >     │
        │       free-composite-disk > free-in-stack > │
        │       free-on-canvas > available            │
        └─────────────────────────────────────────────┘
                            │
                            ▼
            return { state, canRemove, removeAction, buttonText }
    }


┌──────────────────────────────────────────────────────────────────────────┐
│                         КЛЮЧЕВЫЕ ПРАВИЛА                                 │
└──────────────────────────────────────────────────────────────────────────┘

✅ ПРАВИЛО 1: Только ПОСЛЕДНИЙ груз в цепочке можно снять
   attached-last    → [Снять] ✅
   attached-middle  → НЕТ кнопки

✅ ПРАВИЛО 2: Диски на подвешенной штанге НЕЛЬЗЯ снять отдельно
   attached-composite-disk → НЕТ кнопки
   Действие: Снять штангу целиком

✅ ПРАВИЛО 3: Диски на свободной штанге МОЖНО убрать отдельно
   free-composite-disk → [Убрать диск] ✅
   Эффект: Масса штанги уменьшается

✅ ПРАВИЛО 4: Все грузы в стопке имеют кнопку "Убрать"
   Нижний груз → Убирает ВСЮ стопку
   Средний/верхний → Убирает ТОЛЬКО этот груз

✅ ПРАВИЛО 5: При снятии штанги возвращаются ВСЕ диски
   detachWeight(rodId) → Возврат rod + disks

✅ ПРАВИЛО 6: При убирании штанги со стола возвращаются ВСЕ диски
   removeFreeWeight(rodId) → Возврат rod + disks

✅ ПРАВИЛО 7: Нельзя надеть диск на подвешенную штангу
   canStackWeights() → Проверка isRodAttached
   Если true → return false + показать toast


┌──────────────────────────────────────────────────────────────────────────┐
│                       ГРАФ ЗАВИСИМОСТЕЙ                                  │
└──────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────┐
                    │  getWeightState()   │
                    │  (ЦЕНТРАЛЬНАЯ)      │
                    └─────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │                               │
              ▼                               ▼
    ┌───────────────────┐          ┌────────────────────┐
    │ renderWeights     │          │ getWeightStatus    │
    │   Inventory()     │          │    Text()          │
    └───────────────────┘          └────────────────────┘
              │                               │
              │ uses                          │ uses
              ▼                               ▼
    [Управление кнопками]         [Генерация статуса]
              │                               │
              │                               │
              ▼                               ▼
    ┌──────────────────┐          ┌────────────────────┐
    │ Обработчики      │          │ Текст в UI         │
    │  onClick:        │          │ "На пружине (2-й)" │
    │  - detachWeight  │          └────────────────────┘
    │  - removeFree    │
    └──────────────────┘


┌──────────────────────────────────────────────────────────────────────────┐
│                        ИТОГИ                                             │
└──────────────────────────────────────────────────────────────────────────┘

🎯 Централизованная логика определения состояния
📊 8 чётко определённых состояний груза
🔧 Автоматическое управление кнопками
✅ Предсказуемое поведение для всех сценариев
🚫 Защита от некорректных действий (диски на подвешенной штанге)
📝 Подробное логирование для отладки
🎨 Согласованный UI для всех типов грузов

─────────────────────────────────────────────────────────────────────────────
Дата: 22 октября 2025
Файл: experiment-1-spring.js
Функции: getWeightState(), getWeightStatusText(), renderWeightsInventory()
─────────────────────────────────────────────────────────────────────────────
```
